<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flirika</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="app">

  <div class="top">
    <!-- –ú–æ—è –∫–∞–º–µ—Ä–∞ -->
    <div class="video-box">
      <video id="myVideo" autoplay muted playsinline></video>
      <div class="placeholder" id="myLabel">–ú–æ—è –∫–∞–º–µ—Ä–∞</div>

      <div class="token-panel">
        <button class="buy-btn" id="buyBtn">BUY</button>
        <div class="balance">0.007$</div>
      </div>

      <button id="flipBtn" class="control-btn">üîÅ</button>

      <div class="my-controls">
        <button id="nextBtn" class="control-btn" style="background:#2ecc71;">‚è≠</button>
        <button id="startBtn" class="control-btn" style="background:#3498db;">‚ñ∂Ô∏è</button>
        <button id="endBtn" class="control-btn" style="background:#e74c3c;">‚èπ</button>
      </div>
    </div>

    <!-- –ö–∞–º–µ—Ä–∞ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ -->
    <div class="video-box">
      <video id="partnerVideo" autoplay playsinline></video>
      <div class="placeholder">–°–æ–±–µ—Å–µ–¥–Ω–∏–∫</div>
    </div>
  </div>

  <!-- –ß–∞—Ç -->
  <div class="bottom">
    <div class="chat" id="chat">
      <p class="system">–ß–∞—Ç –≥–æ—Ç–æ–≤</p>
    </div>
    <div class="input-area">
      <input id="textInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">
      <button class="send" id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>

</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>
<script>
const socket = io();

// –í–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç—ã
const myVideo = document.getElementById('myVideo');
const partnerVideo = document.getElementById('partnerVideo');
const myLabel = document.getElementById('myLabel');

// –ö–Ω–æ–ø–∫–∏
const startBtn = document.getElementById('startBtn');
const endBtn = document.getElementById('endBtn');
const nextBtn = document.getElementById('nextBtn');
const sendBtn = document.getElementById('sendBtn');
const input = document.getElementById('textInput');
const buyBtn = document.getElementById('buyBtn');

let stream;
let peer;

// ===== –ö–∞–º–µ—Ä–∞ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω =====
async function startMedia() {
    stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    myVideo.srcObject = stream;
}

// ===== WebRTC —Å–µ—Å—Å–∏—è =====
function startPeer(initiator) {
    peer = new SimplePeer({ initiator, trickle: false, stream });

    peer.on('signal', data => socket.emit('signal', data));
    peer.on('stream', remoteStream => partnerVideo.srcObject = remoteStream);
    peer.on('close', () => partnerVideo.srcObject = null);
}

// ===== Socket.io —Å–æ–±—ã—Ç–∏—è =====
socket.on('partnerFound', () => startPeer(true));
socket.on('signal', data => peer.signal(data.signal));
socket.on('chatMessage', data => addChatMessage('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫', data.text));
socket.on('partnerDisconnected', () => partnerVideo.srcObject = null);

// ===== –ß–∞—Ç =====
function addChatMessage(user, text){
    const p = document.createElement('p');
    p.textContent = `${user}: ${text}`;
    document.getElementById('chat').appendChild(p);
}

// ===== –ö–Ω–æ–ø–∫–∏ =====
startBtn.onclick = async () => {
    await startMedia();
    socket.emit('findPartner');
};

nextBtn.onclick = () => {
    if (peer) peer.destroy();
    partnerVideo.srcObject = null;
    socket.emit('findPartner');
};

endBtn.onclick = () => {
    if (stream) stream.getTracks().forEach(t => t.stop());
    if (peer) peer.destroy();
    partnerVideo.srcObject = null;
    myVideo.srcObject = null;
};

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
sendBtn.onclick = () => {
    if(input.value.trim()) {
        addChatMessage('–í—ã', input.value);
        socket.emit('chatMessage', input.value);
        input.value = '';
    }
};
input.addEventListener('keydown', e => { if(e.key==='Enter') sendBtn.click(); });

// –ó–≤—É–∫ BUY
buyBtn.onclick = () => {
    const audio = new Audio('coin.mp3');
    audio.play();
};
</script>
</body>
</html>
