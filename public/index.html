<script>
const myVideo = document.getElementById("myVideo");
const partnerVideo = document.getElementById("partnerVideo");
const startBtn = document.getElementById("startBtn");
const nextBtn = document.getElementById("nextBtn");
const endBtn = document.getElementById("endBtn");
const input = document.getElementById("textInput");
const sendBtn = document.getElementById("sendBtn");
const chat = document.getElementById("chat");

let localStream;
let pc;
let ws;

// ===== WebSocket сигналинг =====
function connectWS() {
  ws = new WebSocket("wss://" + location.host);
  ws.onmessage = async (event) => {
    const data = JSON.parse(event.data);
    if (data.sdp) {
      await pc.setRemoteDescription(data.sdp);
      if (data.sdp.type === "offer") {
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        ws.send(JSON.stringify({ sdp: pc.localDescription }));
      }
    } else if (data.ice) {
      try { await pc.addIceCandidate(data.ice); } catch(e){}
    }
  };
}

// ===== WebRTC =====
async function startCall() {
  localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
  myVideo.srcObject = localStream;
  myVideo.style.display = "block";

  pc = new RTCPeerConnection();

  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

  pc.ontrack = e => {
    partnerVideo.srcObject = e.streams[0];
    partnerVideo.style.display = "block";
  };

  pc.onicecandidate = e => {
    if (e.candidate) ws.send(JSON.stringify({ ice: e.candidate }));
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  ws.send(JSON.stringify({ sdp: pc.localDescription }));
}

// ===== Кнопки =====
startBtn.onclick = async () => {
  connectWS();
  await startCall();
};

endBtn.onclick = () => {
  pc?.close();
  localStream?.getTracks().forEach(t=>t.stop());
  partnerVideo.srcObject = null;
  myVideo.srcObject = null;
};

sendBtn.onclick = () => {
  if(input.value.trim()){
    const p = document.createElement("p");
    p.textContent = "Вы: " + input.value;
    chat.appendChild(p);
    ws.send(JSON.stringify({ chat: input.value }));
    input.value = "";
  }
};

// Чат
ws?.onmessage = (event) => {
  const data = JSON.parse(event.data);
  if(data.chat){
    const p = document.createElement("p");
    p.textContent = "Собеседник: " + data.chat;
    chat.appendChild(p);
  }
};
</script>
