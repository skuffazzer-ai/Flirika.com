<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flirika Chat</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="app">

  <!-- TOP VIDEO -->
  <div class="top">
    <!-- –ú–æ—è –∫–∞–º–µ—Ä–∞ -->
    <div class="video-box">
      <video id="myVideo" autoplay muted playsinline></video>
      <div class="placeholder" id="myLabel">–ú–æ—è –∫–∞–º–µ—Ä–∞</div>

      <div class="token-panel">
        <button class="buy-btn" id="buyBtn">BUY</button>
        <div class="balance">0.007$</div>
      </div>

      <button id="flipBtn" class="control-btn">üîÅ</button>

      <div class="my-controls">
        <button id="nextBtn" class="control-btn" style="background:#2ecc71;display:none;">‚è≠</button>
        <button id="startBtn" class="control-btn" style="background:#3498db;">‚ñ∂Ô∏è</button>
        <button id="endBtn" class="control-btn" style="background:#e74c3c;display:none;">‚èπ</button>
      </div>
    </div>

    <!-- –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ -->
    <div class="video-box">
      <video id="partnerVideo" autoplay playsinline></video>
      <div class="placeholder">–°–æ–±–µ—Å–µ–¥–Ω–∏–∫</div>

      <button class="control-btn" id="reportBtn" style="top:8px; right:8px;">üö©</button>
      <button class="control-btn" id="likeBtn" style="top:8px; left:8px;">‚ù§Ô∏è</button>
      <button class="control-btn" id="giftBtn" style="bottom:8px; left:8px;">üéÅ</button>
    </div>
  </div>

  <!-- CHAT -->
  <div class="bottom">
    <div class="chat" id="chat">
      <p class="system">–ß–∞—Ç –≥–æ—Ç–æ–≤</p>
    </div>

    <div class="input-area">
      <input id="textInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">
      <button class="send" id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

const myVideo = document.getElementById("myVideo");
const partnerVideo = document.getElementById("partnerVideo");
const startBtn = document.getElementById("startBtn");
const nextBtn = document.getElementById("nextBtn");
const endBtn = document.getElementById("endBtn");
const flipBtn = document.getElementById("flipBtn");
const sendBtn = document.getElementById("sendBtn");
const input = document.getElementById("textInput");
const buyBtn = document.getElementById("buyBtn");

let myStream = null;
let pc = null;
let usingFront = true;

const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

// ===== FUNCTIONS =====
async function startCamera() {
  myStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: usingFront ? "user":"environment" }, audio: true });
  myVideo.srcObject = myStream;
}

function stopCamera() {
  if(myStream) myStream.getTracks().forEach(t=>t.stop());
  myVideo.srcObject = null;
}

// ===== WEBRTC =====
function createPeer() {
  pc = new RTCPeerConnection(config);
  myStream.getTracks().forEach(track => pc.addTrack(track, myStream));

  pc.onicecandidate = e => { if(e.candidate) socket.emit("signal", { candidate: e.candidate }); };
  pc.ontrack = e => { partnerVideo.srcObject = e.streams[0]; };
}

// ===== SOCKET EVENTS =====
socket.on("partnerFound", async () => {
  createPeer();
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  socket.emit("signal", { sdp: offer });
});

socket.on("signal", async (data) => {
  if(data.sdp) {
    await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
    if(data.sdp.type === "offer") {
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      socket.emit("signal", { sdp: answer });
    }
  }
  if(data.candidate) pc.addIceCandidate(new RTCIceCandidate(data.candidate));
});

socket.on("partnerLeft", () => { partnerVideo.srcObject = null; alert("–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ —É—à—ë–ª"); });

socket.on("chat", msg => {
  const p = document.createElement("p"); p.textContent = "–°–æ–±–µ—Å–µ–¥–Ω–∏–∫: "+msg; document.getElementById("chat").appendChild(p);
});

// ===== BUTTONS =====
startBtn.onclick = async () => {
  await startCamera();
  startBtn.style.display = "none"; endBtn.style.display = "block"; nextBtn.style.display = "block";
  socket.emit("signal", {}); // trigger peer search
};

nextBtn.onclick = () => { partnerVideo.srcObject = null; socket.emit("signal", {}); };

endBtn.onclick = () => { stopCamera(); partnerVideo.srcObject=null; startBtn.style.display="block"; endBtn.style.display="none"; nextBtn.style.display="none"; };

flipBtn.onclick = async () => { usingFront = !usingFront; stopCamera(); await startCamera(); };

sendBtn.onclick = () => { const msg = input.value.trim(); if(msg){ socket.emit("chat", msg); const p = document.createElement("p"); p.textContent = "–í—ã: "+msg; document.getElementById("chat").appendChild(p); input.value=""; } };

buyBtn.onclick = () => { const ctx = new (window.AudioContext||window.webkitAudioContext)(); for(let i=0;i<3;i++){ const buffer = ctx.createBuffer(1, ctx.sampleRate*0.2, ctx.sampleRate); const data = buffer.getChannelData(0); for(let j=0;j<data.length;j++) data[j]=(Math.random()*2-1)*0.3; const source=ctx.createBufferSource(); source.buffer=buffer; const gain=ctx.createGain(); gain.gain.setValueAtTime(0.2,ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+0.2); source.connect(gain).connect(ctx.destination); source.start(ctx.currentTime+i*0.05); source.stop(ctx.currentTime+0.25+i*0.05); } };
</script>
</body>
</html>
